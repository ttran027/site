@page "/calculators"
@using Client.Contract.Models
@using Client.Contract.Models.Crypto
@using Client.Contract.Stores
@using Client.CryptoPrices.PricesTable
@using Client.Shared

<PageTitleComponent Title="Calculators"/>

<MudContainer Class="d-flex flex-column pa-0 align-center" MaxWidth="MaxWidth.ExtraSmall">
    <MudContainer Class="d-flex flex-row pa-0">
        <MudContainer Class="d-flex flex-column pa-3 align-start">
            <MudNumericField Class="mb-2" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" @bind-Value="Inputs.PurchasedPrice" Label="Purchased Price" HideSpinButtons Immediate DebounceInterval="300" OnDebounceIntervalElapsed="Calculate"/>
            <MudNumericField Class="mb-2" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" @bind-Value="Inputs.SellPrice" Label="Selling Price" HideSpinButtons Immediate DebounceInterval="300" OnDebounceIntervalElapsed="Calculate"/>                   
        </MudContainer>
        <MudContainer Class="d-flex pa-3 flex-column">
            <MudNumericField Class="mb-2" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" @bind-Value="Inputs.Amount" Label="Amount" HideSpinButtons Immediate DebounceInterval="300" OnDebounceIntervalElapsed="Calculate"/>
            <MudText Typo="Typo.h6" Class="mb-2">@Outputs.GetFinal().ToString("C")</MudText>
            @((Outputs.GainRate*100).ToPercent(Typo.body1))
        </MudContainer>
    </MudContainer>
    <PricesTableComponent />
</MudContainer>

@code {
    private GainCalculatorInput Inputs = new();
    private GainCalculatorOutput Outputs = new();

    [Parameter]
    public string Class { get; set; } = string.Empty;

    [Inject]
    private IMediator Mediator { get; set; } = null!;

    [Inject]
    private IState<GainCalculatorState> State {  get;  set; } = null!;

    [Inject]
    private IDispatcher Dispatcher { get; set; } = null!;

    protected override void OnInitialized()
    {
        Inputs = State.Value.Input;
        Outputs = State.Value.Output;
        base.OnInitialized();
    }

    private void UpdateGainCalulatorState()
    {
        Dispatcher.Dispatch(new GainCalculatorInputsEnterAction() { Input = Inputs, Output = Outputs });
    }

    private void Calculate()
    {
        var validator = new GainCalculatorInputValidator();
        var validationResult = validator.Validate(Inputs);
        if (validationResult.IsValid)
        {
            var gainRate = (Inputs.SellPrice - Inputs.PurchasedPrice)/Inputs.PurchasedPrice;
            Outputs.Invesment = Inputs.Amount;
            Outputs.GainRate = gainRate;
            Outputs.Gain = gainRate * Inputs.Amount;
        }
        UpdateGainCalulatorState();
    }
}